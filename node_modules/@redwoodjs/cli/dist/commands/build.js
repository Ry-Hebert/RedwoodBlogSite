"use strict";

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js/object/define-property");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports.handler = exports.builder = exports.description = exports.command = void 0;

var _map = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/instance/map"));

var _includes = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/instance/includes"));

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _execa = _interopRequireDefault(require("execa"));

var _listr = _interopRequireDefault(require("listr"));

var _listrVerboseRenderer = _interopRequireDefault(require("listr-verbose-renderer"));

var _terminalLink = _interopRequireDefault(require("terminal-link"));

var _lib = require("../lib");

var _colors = _interopRequireDefault(require("../lib/colors"));

var _generate = require("./dbCommands/generate");

const apiExists = _fs.default.existsSync((0, _lib.getPaths)().api.src);

const webExists = _fs.default.existsSync((0, _lib.getPaths)().web.src);

const optionDefault = (apiExists, webExists) => {
  let options = [];
  if (apiExists) options.push('api');
  if (webExists) options.push('web');
  return options;
};

const command = 'build [side..]';
exports.command = command;
const description = 'Build for production';
exports.description = description;

const builder = yargs => {
  yargs.positional('side', {
    choices: ['api', 'web'],
    default: optionDefault(apiExists, webExists),
    description: 'Which side(s) to build',
    type: 'array'
  }).option('stats', {
    default: false,
    description: `Use ${(0, _terminalLink.default)('Webpack Bundle Analyzer', 'https://github.com/webpack-contrib/webpack-bundle-analyzer')}`,
    type: 'boolean'
  }).option('verbose', {
    alias: 'v',
    default: false,
    description: 'Print more',
    type: 'boolean'
  }).epilogue(`Also see the ${(0, _terminalLink.default)('Redwood CLI Reference', 'https://redwoodjs.com/reference/command-line-interface#build')}`);
};

exports.builder = builder;

const handler = async ({
  side = ['api', 'web'],
  verbose = false,
  stats = false
}) => {
  if ((0, _includes.default)(side).call(side, 'api')) {
    try {
      await (0, _generate.handler)({
        verbose,
        force: true
      });
    } catch (e) {
      console.log(_colors.default.error(e.message));
      process.exit(1);
    }
  }

  const execCommandsForSides = {
    api: {
      // must use path.join() here, and for 'web' below, to support Windows
      cwd: _path.default.join((0, _lib.getPaths)().base, 'api'),
      cmd: "yarn cross-env NODE_ENV=production babel src --out-dir dist --delete-dir-on-start --extensions .ts,.js --ignore '**/*.test.ts,**/*.test.js,**/__tests__'"
    },
    web: {
      cwd: _path.default.join((0, _lib.getPaths)().base, 'web'),
      cmd: `yarn webpack --config ../node_modules/@redwoodjs/core/config/webpack.${stats ? 'stats' : 'production'}.js`
    }
  };

  if (stats) {
    side = ['web'];
    console.log(' ⏩ Skipping `api` build because stats only works for Webpack at the moment.');
  }

  const tasks = new _listr.default((0, _map.default)(side).call(side, sideName => {
    const {
      cwd,
      cmd
    } = execCommandsForSides[sideName];
    return {
      title: `Building "${sideName}"${stats && ' for stats' || ''}...`,
      task: () => {
        return (0, _execa.default)(cmd, undefined, {
          stdio: verbose ? 'inherit' : 'pipe',
          shell: true,
          cwd
        });
      }
    };
  }), {
    renderer: verbose && _listrVerboseRenderer.default
  });

  try {
    await tasks.run();
  } catch (e) {
    console.log(_colors.default.error(e.message));
    process.exit(1);
  }
};

exports.handler = handler;